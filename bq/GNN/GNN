-- S0: –°–µ–º–µ–Ω–∞ (addresses + activity window)
-- –õ–ò–ù–ï–ô–ù–û. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å SHARD FILTER –¥–ª—è –±–∞—Ç—á–µ–π.

CREATE OR REPLACE TABLE `driven-airway-469812-v8.GNN2.S0_seeds`
OPTIONS (description="Seeds: addresses with start/end of activity; lowercase") AS
SELECT
  LOWER(address) AS address,
  activity_start_ts AS start_ts,
  COALESCE(activity_end_ts, CURRENT_TIMESTAMP()) AS end_ts
FROM `driven-airway-469812-v8.merged_accounts_base.base0_contracts_balanced_v1`
WHERE activity_start_ts IS NOT NULL
-- AND MOD(ABS(FARM_FINGERPRINT(LOWER(address))), 256) BETWEEN 0 AND 31  -- SHARD FILTER (optional)
;

-- S1: –ü–µ—Ä–≤–æ–µ —Ä–µ–±—Ä–æ (L1): –≤—Å–µ —Å–¥–µ–ª–∫–∏, –≥–¥–µ –æ–¥–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞ ‚Äî seed, –∏ ts ‚àà [start_ts,end_ts]
-- –î–í–ê semi-join'–∞ + UNION ALL (–±—ã—Å—Ç—Ä–µ–µ, —á–µ–º OR). –õ–ò–ù–ï–ô–ù–û –ø–æ E –≤ –ø–µ—Ä–∏–æ–¥–∞—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

CREATE OR REPLACE TABLE `driven-airway-469812-v8.GNN2.S1_e1_raw`
PARTITION BY day
CLUSTER BY seed_addr, from_address, to_address AS
WITH t AS (
  SELECT
    `hash` AS tx_hash,              -- üëà –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –±–µ–∫—Ç–∏–∫–∏
    from_address,
    to_address,
    block_number,
    block_timestamp AS ts,
    value AS value_wei_raw,
    gas_price AS gas_price_wei,
    receipt_gas_used AS gas_used,
    nonce,
    input AS input_bytes
  FROM `bigquery-public-data.crypto_ethereum.transactions`
)
SELECT
  LOWER(t.from_address) AS from_address,
  LOWER(t.to_address)   AS to_address,
  t.block_number,
  t.ts                  AS timestamp,
  t.value_wei_raw,
  t.gas_price_wei,
  t.gas_used,
  t.nonce,
  t.input_bytes,
  t.tx_hash,
  DATE(t.ts)            AS day,
  s.address             AS seed_addr
FROM t
JOIN `driven-airway-469812-v8.GNN2.S0_seeds` s
  ON LOWER(t.from_address) = s.address
 AND t.ts BETWEEN s.start_ts AND s.end_ts

UNION ALL

SELECT
  LOWER(t.from_address),
  LOWER(t.to_address),
  t.block_number,
  t.ts,
  t.value_wei_raw,
  t.gas_price_wei,
  t.gas_used,
  t.nonce,
  t.input_bytes,
  t.tx_hash,
  DATE(t.ts),
  s.address
FROM t
JOIN `driven-airway-469812-v8.GNN2.S0_seeds` s
  ON LOWER(t.to_address) = s.address
 AND t.ts BETWEEN s.start_ts AND s.end_ts
;

-- S2: –°—á–∏—Ç–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–π –≤–µ—Å (Wei) –∏ —Å–≤–µ–∂–µ—Å—Ç—å –ø–æ –ø–∞—Ä–µ (seed, neighbor, day) ‚Üí –±–µ—Ä—ë–º TOP 50.
-- –ö—Ä–∏—Ç–µ—Ä–∏–π (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è fraud): SUM(value_wei_raw) DESC, –∑–∞—Ç–µ–º MAX(timestamp) DESC.
-- –î–µ—Ç. tie-breaker: neighbor_addr ASC. –õ–ò–ù–ï–ô–ù–û + —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤ –æ–∫–Ω–∞—Ö (—É–∑–∫–∏–µ).

CREATE OR REPLACE TABLE `driven-airway-469812-v8.GNN2.S2_l1_top15`
PARTITION BY day
CLUSTER BY seed_addr, neighbor_addr AS
WITH pairs AS (
  SELECT
    seed_addr,
    day,
    CASE WHEN from_address = seed_addr THEN to_address ELSE from_address END AS neighbor_addr,
    value_wei_raw,
    timestamp
  FROM `driven-airway-469812-v8.GNN2.S1_e1_raw`
),
scored AS (
  SELECT
    seed_addr,
    neighbor_addr,
    day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(timestamp)     AS last_ts
  FROM pairs
  GROUP BY seed_addr, neighbor_addr, day
)
SELECT seed_addr, neighbor_addr, day, sum_value_wei, last_ts
FROM (
  SELECT
    seed_addr, neighbor_addr, day, sum_value_wei, last_ts,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 15;

-- ==========================================================
-- S3: –°–æ—Å–µ–¥–∏ –≤—Ç–æ—Ä–æ–≥–æ —É—Ä–æ–≤–Ω—è (L2)
-- ----------------------------------------------------------
-- –ù–∞ –≤—Ö–æ–¥–µ:
--   ‚Ä¢ S2_l1_top15 ‚Äî —Ç–æ–ø-15 —Å–æ—Å–µ–¥–µ–π –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è (L1) –¥–ª—è (seed, day)
-- 
-- –ß—Ç–æ –¥–µ–ª–∞–µ–º:
--   1) –ë–µ—Ä—ë–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –∑–∞ –¥–Ω–∏, –≥–¥–µ –µ—Å—Ç—å L1 (S3_tx_by_day).
--   2) –°—Ç—Ä–æ–∏–º –∏–Ω–¥–µ–∫—Å (S3_idx_addr_by_day) –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ tx –ø–æ addr.
--   3) –ß–µ—Ä–µ–∑ –±–∞—Ç—á–∏ (—à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ hash(addr) % 64) –∏—â–µ–º –≤—Å–µ –∞–¥—Ä–µ—Å–∞,
--      –∫–æ—Ç–æ—Ä—ã–µ —Å–≤—è–∑–∞–Ω—ã —Å L1 –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å ‚Üí —ç—Ç–æ L2 –∫–∞–Ω–¥–∏–¥–∞—Ç—ã.
--   4) –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –ø–æ (seed, day, L2), —Å—á–∏—Ç–∞–µ–º –≤–µ—Å = SUM(value_wei_raw),
--      —Å–≤–µ–∂–µ—Å—Ç—å = MAX(ts), —á–∞—Å—Ç–æ—Ç—É = COUNT(*).
--   5) –û—Å—Ç–∞–≤–ª—è–µ–º TOP-5 L2 —Å–æ—Å–µ–¥–µ–π –Ω–∞ (seed, day).
--
-- –í—ã—Ö–æ–¥: S3_l2_top5
-- ==========================================================
-- –ö—ç—à: —Ç–æ–ª—å–∫–æ –¥–Ω–∏, –≥–¥–µ –µ—Å—Ç—å L1-—Å–æ—Å–µ–¥–∏ (–∏–∑ S2_l1_top50)
CREATE OR REPLACE TABLE `driven-airway-469812-v8.GNN2.S3_tx_by_day`
PARTITION BY day
CLUSTER BY from_address, to_address AS
WITH days AS (
  SELECT DISTINCT day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
)
SELECT
  `hash`                AS tx_hash,
  LOWER(from_address)   AS from_address,
  LOWER(to_address)     AS to_address,
  block_number,
  block_timestamp       AS ts,
  DATE(block_timestamp) AS day,
  value                 AS value_wei_raw,
  gas_price             AS gas_price_wei,
  receipt_gas_used      AS gas_used,
  nonce,
  input                 AS input
FROM `bigquery-public-data.crypto_ethereum.transactions`
WHERE DATE(block_timestamp) IN (SELECT day FROM days);

-- –£–∑–∫–∏–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞ JOIN (–±–µ–∑ –≤–∑—Ä—ã–≤–∞ –ø–æ OR)
CREATE OR REPLACE TABLE `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day`
PARTITION BY day
CLUSTER BY addr AS
SELECT DISTINCT day, from_address AS addr, tx_hash
FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day`
UNION ALL
SELECT DISTINCT day, to_address   AS addr, tx_hash
FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day`;

-- —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É —Å –Ω—É–∂–Ω—ã–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏ –∏ —Å—Ö–µ–º–æ–π
CREATE OR REPLACE TABLE `driven-airway-469812-v8.GNN2.S3_l2_top5`
(
  seed_addr       STRING,
  neighbor2_addr  STRING,
  day             DATE,
  sum_value_wei   NUMERIC,
  last_ts         TIMESTAMP,
  tx_cnt          INT64
)
PARTITION BY day
CLUSTER BY seed_addr, neighbor2_addr;


-- ===== –ë–∞—Ç—á L2 #1: L1-—à–∞—Ä–¥—ã 0‚Äì3 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 0 AND 3
),
hits AS (
  -- transactions –≥–¥–µ —É—á–∞—Å—Ç–≤—É–µ—Ç L1-—Å–æ—Å–µ–¥ (–≤ —ç—Ç–æ—Ç –¥–µ–Ω—å)
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  -- –Ω–∞—Ö–æ–¥–∏–º L2-–∞–¥—Ä–µ—Å (–ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw AS value_wei_raw,
    t.ts AS ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  -- –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º –ø–æ (seed, day, L2)
  SELECT
    seed_addr,
    neighbor2_addr,
    day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
-- –±–µ—Ä—ë–º TOP-20 L2 –Ω–∞ (seed, day)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #2: L1-—à–∞—Ä–¥—ã 4‚Äì7 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 4 AND 7
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #3: L1-—à–∞—Ä–¥—ã 8‚Äì11 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 8 AND 11
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #4: L1-—à–∞—Ä–¥—ã 12‚Äì15 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 12 AND 15
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #5: L1-—à–∞—Ä–¥—ã 16‚Äì19 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 16 AND 19
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #6: L1-—à–∞—Ä–¥—ã 20‚Äì23 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 20 AND 23
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #7: L1-—à–∞—Ä–¥—ã 24‚Äì27 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 24 AND 27
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #8: L1-—à–∞—Ä–¥—ã 28‚Äì31 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 28 AND 31
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #8: L1-—à–∞—Ä–¥—ã 32‚Äì35 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 32 AND 35
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #9: L1-—à–∞—Ä–¥—ã 36‚Äì39 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 36 AND 39
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #10: L1-—à–∞—Ä–¥—ã 40‚Äì43 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 40 AND 43
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #11: L1-—à–∞—Ä–¥—ã 44‚Äì47 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 44 AND 47
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #12: L1-—à–∞—Ä–¥—ã 48‚Äì51 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 48 AND 51
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #13: L1-—à–∞—Ä–¥—ã 52‚Äì55 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 52 AND 55
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #14: L1-—à–∞—Ä–¥—ã 56‚Äì59 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 56 AND 59
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- ===== –ë–∞—Ç—á L2 #15: L1-—à–∞—Ä–¥—ã 60‚Äì63 =====
INSERT INTO `driven-airway-469812-v8.GNN2.S3_l2_top5`
WITH l1_sharded AS (
  SELECT seed_addr, neighbor_addr, day
  FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
  WHERE MOD(ABS(FARM_FINGERPRINT(neighbor_addr)), 64) BETWEEN 60 AND 63
),
hits AS (
  SELECT i.day, i.tx_hash, l.seed_addr, l.neighbor_addr
  FROM `driven-airway-469812-v8.GNN2.S3_idx_addr_by_day` i
  JOIN l1_sharded l
    ON i.day = l.day AND i.addr = l.neighbor_addr
),
pairs AS (
  SELECT
    h.seed_addr,
    CASE
      WHEN t.from_address = h.neighbor_addr THEN t.to_address
      ELSE t.from_address
    END AS neighbor2_addr,
    t.day,
    t.value_wei_raw,
    t.ts
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN hits h
    ON t.day = h.day AND t.tx_hash = h.tx_hash
),
scored AS (
  SELECT
    seed_addr, neighbor2_addr, day,
    SUM(value_wei_raw) AS sum_value_wei,
    MAX(ts)            AS last_ts,
    COUNT(*)           AS tx_cnt
  FROM pairs
  GROUP BY seed_addr, neighbor2_addr, day
)
SELECT seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt
FROM (
  SELECT
    seed_addr, neighbor2_addr, day, sum_value_wei, last_ts, tx_cnt,
    ROW_NUMBER() OVER (
      PARTITION BY seed_addr, day
      ORDER BY sum_value_wei DESC, last_ts DESC, neighbor2_addr
    ) AS rn
  FROM scored
)
WHERE rn <= 5
;

-- S5: –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Ñ—Ä–æ–Ω—Ç–∏—Ä –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ seed –∏ –¥–Ω—è
-- –õ–ò–ù–ï–ô–ù–û, –±–µ–∑ —à–∏—Ä–æ–∫–∏—Ö –¥–∂–æ–π–Ω–æ–≤
CREATE OR REPLACE TABLE `driven-airway-469812-v8.GNN2.S5_frontier_l1l2`
PARTITION BY day
CLUSTER BY seed_addr, addr AS
SELECT seed_addr, day, neighbor_addr AS addr
FROM `driven-airway-469812-v8.GNN2.S2_l1_top15`
UNION ALL
SELECT seed_addr, day, neighbor2_addr AS addr       -- <-- –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
FROM `driven-airway-469812-v8.GNN2.S3_l2_top5`;

-- S6: —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –≥—Ä–∞—Ñ–∞, —Ç–æ—á–Ω–æ—Å—Ç—å ‚Äî –ø–æ –¥–Ω—è–º
-- –õ–ò–ù–ï–ô–ù–û: —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞ –ø–æ –∫–ª—é—á–∞–º + –ø–∞—Ä—Ç–∏—Ü–∏–∏ day
-- –ö–ê–ü E2: ‚â§ 30 tx/–¥–µ–Ω—å –Ω–∞ –ø–∞—Ä—É (seed, day, L1, L2)

-- CREATE OR REPLACE TABLE `driven-airway-469812-v8.GNN2.S6_final_tx_daily`
-- PARTITION BY day
-- CLUSTER BY from_address, to_address AS

-- -- ---------------- E1: seed ‚Üî L1 ----------------
-- SELECT
--   from_address,
--   to_address,
--   block_number,
--   timestamp,
--   value_wei_raw,
--   gas_price_wei,
--   gas_used,
--   nonce,
--   input_bytes,
--   tx_hash,
--   day
-- FROM `driven-airway-469812-v8.GNN2.S1_e1_raw`

-- UNION ALL

-- -- ---------------- E2 (–≤–µ—Ç–∫–∞ A): from = L1, to = –≤—ã–±—Ä–∞–Ω–Ω—ã–π L2 ----------------
-- SELECT * EXCEPT(rn) FROM (
--   SELECT
--     t.from_address,
--     t.to_address,
--     t.block_number,
--     t.ts                AS timestamp,
--     t.value_wei_raw,
--     t.gas_price_wei,
--     t.gas_used,
--     t.nonce,
--     t.input             AS input_bytes,
--     t.tx_hash,
--     t.day,
--     ROW_NUMBER() OVER (
--       PARTITION BY l1.seed_addr, t.day, t.from_address, t.to_address
--       ORDER BY t.value_wei_raw DESC, t.block_number DESC, t.tx_hash
--     ) AS rn
--   FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
--   JOIN `driven-airway-469812-v8.GNN2.S2_l1_top30` l1   -- –µ—Å–ª–∏ –¥–µ–ª–∞–ª —Ç–æ–ø-30, –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ–Ω—è–π –Ω–∞ S2_l1_top30
--     ON l1.day = t.day
--    AND t.from_address = l1.neighbor_addr
--   JOIN `driven-airway-469812-v8.GNN2.S3_l2_top10` l2   -- –µ—Å–ª–∏ –¥–µ–ª–∞–ª —Ç–æ–ø-10, –ø–æ–º–µ–Ω—è–π –Ω–∞ S3_l2_top10
--     ON l2.day = t.day
--    AND l2.seed_addr = l1.seed_addr
--    AND l2.neighbor2_addr = t.to_address
-- )
-- WHERE rn <= 30

-- UNION ALL

-- -- ---------------- E2 (–≤–µ—Ç–∫–∞ B): to = L1, from = –≤—ã–±—Ä–∞–Ω–Ω—ã–π L2 ----------------
-- SELECT * EXCEPT(rn) FROM (
--   SELECT
--     t.from_address,
--     t.to_address,
--     t.block_number,
--     t.ts                AS timestamp,
--     t.value_wei_raw,
--     t.gas_price_wei,
--     t.gas_used,
--     t.nonce,
--     t.input             AS input_bytes,
--     t.tx_hash,
--     t.day,
--     ROW_NUMBER() OVER (
--       PARTITION BY l1.seed_addr, t.day, t.to_address, t.from_address
--       ORDER BY t.value_wei_raw DESC, t.block_number DESC, t.tx_hash
--     ) AS rn
--   FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
--   JOIN `driven-airway-469812-v8.GNN2.S2_l1_top30` l1   -- –µ—Å–ª–∏ –¥–µ–ª–∞–ª —Ç–æ–ø-30, –ø–æ–º–µ–Ω—è–π –Ω–∞ S2_l1_top30
--     ON l1.day = t.day
--    AND t.to_address = l1.neighbor_addr
--   JOIN `driven-airway-469812-v8.GNN2.S3_l2_top10` l2   -- –µ—Å–ª–∏ –¥–µ–ª–∞–ª —Ç–æ–ø-10, –ø–æ–º–µ–Ω—è–π –Ω–∞ S3_l2_top10
--     ON l2.day = t.day
--    AND l2.seed_addr = l1.seed_addr
--    AND l2.neighbor2_addr = t.from_address
-- )
-- WHERE rn <= 30
-- ;

-- S6 (–≤–∞—Ä–∏–∞–Ω—Ç B): —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –≥—Ä–∞—Ñ–∞ (–ø–æ –¥–Ω—è–º)
-- –õ–ò–ù–ï–ô–ù–û: —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞ –ø–æ –∫–ª—é—á–∞–º + –ø–∞—Ä—Ç–∏—Ü–∏–∏ day
-- –ü—Ä–∞–≤–∫–∏:
--   ‚Ä¢ L1 = 15 —Å–æ—Å–µ–¥–µ–π/–¥–µ–Ω—å  ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º S2_l1_top15
--   ‚Ä¢ L2 = 5 —Å–æ—Å–µ–¥–µ–π/–¥–µ–Ω—å   ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º S3_l2_top5
--   ‚Ä¢ –ö–ê–ü E2: ‚â§ 20 tx/–¥–µ–Ω—å –Ω–∞ –ø–∞—Ä—É (seed, day, L1, L2)
--   ‚Ä¢ –ê–Ω—Ç–∏-–ø—ã–ª—å: value_wei_raw >= 1e14 (~0.0001 ETH)

CREATE OR REPLACE TABLE `driven-airway-469812-v8.GNN2.S6_final_tx_daily`
PARTITION BY day
CLUSTER BY from_address, to_address AS

-- ---------------- E1: seed ‚Üî L1 (—Ñ–∏–ª—å—Ç—Ä "–ø—ã–ª–∏") ----------------
SELECT
  from_address,
  to_address,
  block_number,
  timestamp,
  value_wei_raw,
  gas_price_wei,
  gas_used,
  nonce,
  input_bytes,
  tx_hash,
  day
FROM `driven-airway-469812-v8.GNN2.S1_e1_raw`
WHERE value_wei_raw >= 1e14   -- –∞–Ω—Ç–∏-–ø—ã–ª—å –Ω–∞ E1

UNION ALL

-- ---------------- E2 (–≤–µ—Ç–∫–∞ A): from = L1, to = –≤—ã–±—Ä–∞–Ω–Ω—ã–π L2 ----------------
SELECT * EXCEPT(rn) FROM (
  SELECT
    t.from_address,
    t.to_address,
    t.block_number,
    t.ts                AS timestamp,
    t.value_wei_raw,
    t.gas_price_wei,
    t.gas_used,
    t.nonce,
    t.input             AS input_bytes,
    t.tx_hash,
    t.day,
    ROW_NUMBER() OVER (
      PARTITION BY l1.seed_addr, t.day, t.from_address, t.to_address
      ORDER BY t.value_wei_raw DESC, t.block_number DESC, t.tx_hash
    ) AS rn
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN `driven-airway-469812-v8.GNN2.S2_l1_top15` l1   -- L1 = 15
    ON l1.day = t.day
   AND t.from_address = l1.neighbor_addr
  JOIN `driven-airway-469812-v8.GNN2.S3_l2_top5`  l2   -- L2 = 5
    ON l2.day = t.day
   AND l2.seed_addr = l1.seed_addr
   AND l2.neighbor2_addr = t.to_address
  WHERE t.value_wei_raw >= 1e14   -- –∞–Ω—Ç–∏-–ø—ã–ª—å –Ω–∞ E2
)
WHERE rn <= 20    -- –∫–∞–ø 20 tx/–¥–µ–Ω—å –Ω–∞ –ø–∞—Ä—É (seed, day, L1‚ÜíL2)

UNION ALL

-- ---------------- E2 (–≤–µ—Ç–∫–∞ B): to = L1, from = –≤—ã–±—Ä–∞–Ω–Ω—ã–π L2 ----------------
SELECT * EXCEPT(rn) FROM (
  SELECT
    t.from_address,
    t.to_address,
    t.block_number,
    t.ts                AS timestamp,
    t.value_wei_raw,
    t.gas_price_wei,
    t.gas_used,
    t.nonce,
    t.input             AS input_bytes,
    t.tx_hash,
    t.day,
    ROW_NUMBER() OVER (
      PARTITION BY l1.seed_addr, t.day, t.to_address, t.from_address
      ORDER BY t.value_wei_raw DESC, t.block_number DESC, t.tx_hash
    ) AS rn
  FROM `driven-airway-469812-v8.GNN2.S3_tx_by_day` t
  JOIN `driven-airway-469812-v8.GNN2.S2_l1_top15` l1   -- L1 = 15
    ON l1.day = t.day
   AND t.to_address = l1.neighbor_addr
  JOIN `driven-airway-469812-v8.GNN2.S3_l2_top5`  l2   -- L2 = 5
    ON l2.day = t.day
   AND l2.seed_addr = l1.seed_addr
   AND l2.neighbor2_addr = t.from_address
  WHERE t.value_wei_raw >= 1e14   -- –∞–Ω—Ç–∏-–ø—ã–ª—å –Ω–∞ E2
)
WHERE rn <= 20    -- –∫–∞–ø 20 tx/–¥–µ–Ω—å –Ω–∞ –ø–∞—Ä—É (seed, day, L2‚ÜíL1)
;


-- S7: –¥–µ–¥—É–ø + –ø—Ä–∏–∑–Ω–∞–∫–∏ —Ä—ë–±–µ—Ä
CREATE OR REPLACE TABLE `driven-airway-469812-v8.GNN2.S7_daily_edges_dedup`
PARTITION BY day
CLUSTER BY from_address, to_address AS
SELECT
  ANY_VALUE(LOWER(from_address)) AS from_address,
  ANY_VALUE(LOWER(to_address))   AS to_address,
  ANY_VALUE(block_number)        AS block_number,
  ANY_VALUE(timestamp)           AS timestamp,
  CAST(ANY_VALUE(value_wei_raw) AS NUMERIC) AS value_wei,  -- Wei (NUMERIC)
  CAST(SAFE_MULTIPLY(ANY_VALUE(gas_price_wei), ANY_VALUE(gas_used)) AS NUMERIC) AS tx_fee_wei,
  ANY_VALUE(nonce)               AS nonce,
  -- –¥–ª–∏–Ω–∞ input –≤ –±–∞–π—Ç–∞—Ö: (–¥–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ "0x")/2
  CAST(DIV(GREATEST(LENGTH(ANY_VALUE(input_bytes)) - 2, 0), 2) AS INT64) AS input_data_size,
  (ANY_VALUE(to_address) IS NULL) AS contract_creation,
  tx_hash,
  day
FROM `driven-airway-469812-v8.GNN2.S6_final_tx_daily`
GROUP BY tx_hash, day;

-- S8.A: —Å–æ–∑–¥–∞—ë–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –æ–¥–∏–Ω —Ä–∞–∑ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç)
CREATE TABLE IF NOT EXISTS `driven-airway-469812-v8.GNN2.transactions_daily` (
  from_address      STRING,
  to_address        STRING,
  block_number      INT64,
  timestamp         TIMESTAMP,
  value_wei         NUMERIC,
  tx_fee_wei        NUMERIC,
  nonce             INT64,
  input_data_size   INT64,
  contract_creation BOOL,
  tx_hash           STRING,
  day               DATE
)
PARTITION BY day
CLUSTER BY from_address, to_address;

-- S8.B: –∑–∞–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ S7
INSERT INTO `driven-airway-469812-v8.GNN2.transactions_daily` (
  from_address, to_address, block_number, timestamp,
  value_wei, tx_fee_wei, nonce, input_data_size, contract_creation,
  tx_hash, day
)
SELECT
  from_address, to_address, block_number, timestamp,
  value_wei, tx_fee_wei, nonce, input_data_size, contract_creation,
  tx_hash, day
FROM `driven-airway-469812-v8.GNN2.S7_daily_edges_dedup`;

